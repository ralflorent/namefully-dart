# This workflow is a modified version of the one generated by GitHub, as well as inspired
# by https://github.com/vanesyan/jetlog.dart/blob/master/.github/workflows/test.yml.

name: build

on:
  push:
    branches: [ main ]
    paths-ignore: [ '**.md' ]
  pull_request:
    branches: [ main ]
    paths-ignore: [ '**.md' ]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest]
        sdk: [stable]

    steps:
      - uses: actions/checkout@v2
      - uses: actions/cache@v2
        with:
          path: '~/.pub-cache'
          key: ${{ runner.os }}-${{ hashFiles('pubspec.yaml') }}

      - uses: dart-lang/setup-dart@v1
        with:
          sdk: ${{ matrix.sdk }}

      - name: Install dependencies
        run: dart pub get

      - name: Analyze project source
        run: dart analyze

      - name: Run tests
        run: dart test

      - name: Collect test coverage
        run: |
          set -e

          echo "Installing coverage tool"
          pub global activate coverage &>/dev/null
          echo "Collecting coverage on port 8888..."
          dart --disable-service-auth-codes \
            --enable-vm-service=8888 \
            --pause-isolates-on-exit \
            test/test_all.dart &

          echo "Generating LCOV report..."
          pub global run coverage:collect_coverage \
            --port=8888 \
            --out=.coverage/coverage.json \
            --wait-paused \
            --resume-isolates && \

          pub global run coverage:format_coverage \
            --lcov \
            --in=.coverage/coverage.json \
            --out=.coverage/lcov.info \
            --packages=.packages \
            --report-on=lib \
            --check-ignore
        shell: bash

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          file: .coverage/lcov.info
          fail_ci_if_error: true
